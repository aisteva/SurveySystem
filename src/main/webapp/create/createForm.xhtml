<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
    <h:head>
        <title>Nauja apklausa</title>
        <h:outputStylesheet name="/css/style.css" />
        <h:outputStylesheet name="/css/create/style.css" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1"/>
    </h:head>
    <f:metadata>
        <f:viewAction action="#{signInController.isSigned}" />
        <f:viewParam name="id"
                     required="false"
                     value="#{createFormController.survey.surveyID}"
                     validator="#{createFormController.validate}"/>
    </f:metadata>
    <h:body style="background: linear-gradient(#29bf89, #0083BB);">
        <ui:include src="/header.xhtml"/>
        <div class="container">
            <h:form>
                <div class="box-shadow col-lg-8 col-lg-offset-2 col-lg-offset-2 col-md-10 col-md-offset-1 col-md-offset-1 col-sm-10 col-sm-offset-1 col-sm-offset-1 col-xs-12">
                    <div class="survey col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h3>
                                    <a style="text-decoration: none; cursor: pointer;" type="button" class="text text-primary glyphicon glyphicon-open pull-right" data-toggle="modal" data-target="#import"/>
                                </h3>
                            </div>
                            <div class="surveyTitle col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h:inputText value="#{createFormController.survey.title}" styleClass="onlyBottomBorder" a:placeholder="Apklausos pavadinimas">
                                    <f:ajax render="@form"/>
                                </h:inputText>
                            </div>
                            <div class="surveyDescription col-lg-12 col-md-12 col-sm-12 col-xs-12 input-group">
                                <h:inputTextarea value="#{createFormController.survey.description}" a:placeholder="Aprašymas" styleClass="form-control custom-control" rows="5" style="resize: none;">
                                    <f:ajax render="@form"/>
                                </h:inputTextarea>
                            </div>
                            <div class="row">
                                <div class="col-lg-5 col-md-5 col-sm-6 col-xs-12">
                                    <div class="row">
                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                            <p:outputLabel for="startDate" value="Pradžios data * "/>
                                        </div>
                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                                            <p:calendar id="startDate" value="#{createFormController.survey.startDate}" pattern="yyyy-mm-dd">
                                                <f:ajax render="@form" event="dateSelect"/>
                                            </p:calendar>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5 col-md-5 col-sm-6 col-xs-12">
                                    <div class="row">
                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                            <p:outputLabel for="endDate" value="Pabaigos data "/>
                                        </div>
                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                            <p:calendar id="endDate" value="#{createFormController.survey.endDate}" pattern="yyyy-mm-dd">
                                                <f:ajax render="@form" event="dateSelect"/>
                                            </p:calendar>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-2 col-sm-6 col-xs-12 vertical-align">
                                        <span style="padding-right: 10px;">Privati</span>
                                        <label class="switch">
                                            <h:selectBooleanCheckbox value="#{createFormController.survey.surveyPrivate}">
                                                <f:ajax render="@form"/>
                                            </h:selectBooleanCheckbox>
                                            <div class="slider round"></div>
                                        </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-center">
                            <h3>Puslapis nr. #{createFormController.page}</h3>
                        </div>
                    </div>
                    <h:panelGroup id="survey" >
                        <ui:repeat  value="#{createFormController.questions.get(createFormController.page)}" var="question" varStatus="questionStatus">
                            <div class="one-question">
                                <div class="row question-info">
                                    <div class="question-text col-lg-9 col-md-9 col-sm-8 col-xs-12">
                                        <h:outputLabel value="#{createFormController.getQuestionParentMessage(questionStatus.index)}"/>
                                        <h:inputText value="#{question.questionText}" a:placeholder="Klausimas" styleClass="onlyBottomBorder">
                                            <f:ajax render="@form"/>
                                        </h:inputText>
                                    </div>
                                    <div class="col-lg-3 col-md-3 col-sm-4 col-xs-12 text-right push-down">
                                        <h:selectOneMenu value="#{question.newType}" styleClass="onlyBottomBorder">
                                            <f:selectItems value = "#{question.types}"/>
                                            <f:ajax listener="#{createFormController.changeQuestionType(questionStatus.index)}" render="@form"/>
                                        </h:selectOneMenu>
                                    </div>
                                </div>
                                <div class="answers">
                                   <h:panelGroup rendered="#{question.type == 'TEXT'}">
                                        <ui:include src="text.xhtml"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{question.type == 'CHECKBOX' || question.type == 'MULTIPLECHOICE'}">
                                        <ui:include src="checkboxAndMultiplechoice.xhtml"/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{question.type == 'SCALE'}">
                                        <ui:include src="scale.xhtml"/>
                                    </h:panelGroup>
                                </div>

                                <div class="actions-with-question">
                                    <div class="col-lg-1 col-md-1 col-sm-2 col-xs-2">
                                        <h:commandLink action="#{createFormController.moveQuestionUp(questionStatus.index)}">
                                            <div class="glyphicon glyphicon-triangle-top action-icon"></div>
                                            <f:ajax render="@form"/>
                                        </h:commandLink>
                                    </div>
                                    <div class="col-lg-1 col-md-1 col-sm-2 col-xs-2">
                                        <h:commandLink action="#{createFormController.moveQuestionDown(questionStatus.index)}">
                                            <div class="glyphicon glyphicon-triangle-bottom action-icon"></div>
                                            <f:ajax render="@form"/>
                                        </h:commandLink>
                                    </div>
                                    <div class="col-lg-1 col-md-1 col-sm-2 col-xs-2">
                                        <h:commandLink action="#{createFormController.removeQuestion(questionStatus.index)}">
                                            <div class="glyphicon glyphicon-trash action-icon"></div>
                                            <f:ajax render="@form"/>
                                        </h:commandLink>
                                    </div>
                                    <div class="col-lg-1 col-md-1 col-sm-2 col-xs-2">
                                        <h:commandLink action="#{createFormController.addQuestion(questionStatus.index)}">
                                            <div class="glyphicon glyphicon-plus action-icon"></div>
                                            <f:ajax render="@form"/>
                                        </h:commandLink>
                                    </div>
                                    <div class="col-lg-5 col-md-5 col-sm-4 col-xs-4 vertical-align">
                                        <span style="padding-right: 10px">Privalomas</span>
                                        <label class="switch">
                                            <h:selectBooleanCheckbox value="#{question.required}">
                                                <f:ajax render="@form"/>
                                            </h:selectBooleanCheckbox>
                                            <div class="slider round"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </ui:repeat>
                    </h:panelGroup>
                    <div class="row navigation">

                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 text-left">
                            <c:if test="#{createFormController.page > 1}">
                                <h:commandLink action="#{createFormController.prevPage()}">
                                    <div class="glyphicon glyphicon-chevron-left action-icon"></div>
                                </h:commandLink>
                            </c:if>
                        </div>
                        <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 text-center">
                            <p:commandButton value="Submit form"
                                             styleClass="btn btn-md btn-primary"
                                             action="#{createFormController.createForm(signInPerson.loggedInPerson.email)}"
                                             ajax="false"/>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2 text-right">
                            <h:commandLink action="#{createFormController.nextPage()}">
                                <div class="glyphicon glyphicon-chevron-right action-icon"></div>
                            </h:commandLink>
                        </div>

                    </div>
                    <p:messages globalOnly="true"/>
                </div>

            </h:form>
            <!-- Modal -->
            <div id="import" class="modal fade" role="dialog">
                <div class="modal-dialog">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Įkelti apklausą</h4>
                        </div>
                        <div class="modal-body">
                            <!-- TODO neatsinaujina žinutės, rodo pačią pirmą, kuri buvo, nežinau kaip pataisyt :/ -->
                            <p:messages  id="messages" autoUpdate="true"/>

                            <!-- būtina palikt enctype, kitaip neveiks file upload. Mode paliekam advanced. -->
                            <h:form id="uploadForm" enctype="multipart/form-data">
                                <p:fileUpload fileUploadListener="#{excelImportController.handleFileUpload}"
                                              invalidFileMessage="Neteisingo formato failas"
                                              mode="advanced" update=":surveyImportResults"
                                              uploadLabel="Įkelti"
                                              cancelLabel="Atšaukti"
                                              sizeLimit="100000" allowTypes="/(\.|\/)(xls|xlsx)$/"
                                              label="Pasirinkti" oncomplete="PF('pollSurvey').start()"/>
                                <!-- Kadangi excel importas asinchroninis, naudojam poll, kuris kas sekundę patikrina, ar importas baigtas
                                      Poll pasileidžia po file upload, on complete
                                      Pasibaigia pagal controlleryje esantį pollresult boolean kintamąjį, kuris būna true,
                                      kai failas importuotas. -->
                                <p:poll widgetVar="pollSurvey" interval="1" autoStart="false" listener="#{excelImportController.importSurvey}"
                                        stop="#{not excelImportController.pollResult}" update=":surveyImportResults"/>
                            </h:form>

                            <!-- tada čia pagal tą patį pollResult boolean arba rodom, kad apklausa dar nebaigta importuoti,
                                  arba parodom papildomai kažką. Tai čia šitoj vietoj galima tikrinti, jei apklausa turi submitų, tai tada rodom
                                  statistiką, jei neturi submitų, leidžiam redaguot. arba gal kažkaip kitaip, kaip nuspręsim -->
                            <h:form id="surveyImportResults">
                                <p:outputLabel rendered="#{excelImportController.pollResult}" value="Apklausa importuojama"/>
                                <p:panel rendered="#{not empty excelImportController.importedSurvey}">
                                    <p:outputLabel value="#{excelImportController.importedSurvey.submits}"/>
                                    <p:inputText placeholder="Apklausos pavadinimas" value="#{excelImportController.importedSurvey.title}"/>
                                    <p:inputTextarea placeholder="Apklausos aprašymas" value="#{excelImportController.importedSurvey.description}"/>
                                    <p:commandButton value="Baigti importavimą" action="#{excelImportController.finishImport}"/>
                                </p:panel>
                            </h:form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <ui:include src="/footer.xhtml"/>
    </h:body>
</html>
